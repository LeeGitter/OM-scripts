-- flight_stamina_only

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local root = character:WaitForChild("HumanoidRootPart")

local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

-- stamina
local flyMax = 200
local flyMeter = flyMax
local flyRegenCooldown = false
local flyRegenCooldownTime = 3

-- flight physics
local flying = false
local flySpeed = 0
local flySpeedMax = 175
local flyAccel = 70
local flyDecel = 80
local flyDrainIdle = 10.9 / 20.4
local flyDrainSpeed = 20
local flyDrainMinSpeed = 100
local flyInertiaDecel = 6

local bv = nil
local bg = nil
local flyConn = nil

-- jump activation
local jumpInputActive = false
local jumpInputStart = 0
local jumpHoldThreshold = 0.3

-- UI
local flyGui = Instance.new("BillboardGui")
flyGui.Name = "FlyMeterGui"
flyGui.ResetOnSpawn = false
flyGui.Adornee = root
flyGui.AlwaysOnTop = true
flyGui.MaxDistance = 60
flyGui.SizeOffset = Vector2.new(0,0)
flyGui.StudsOffset = Vector3.new(-4, 0, 0)

if isMobile then
    flyGui.Size = UDim2.new(0, 24, 0, 88)
else
    flyGui.Size = UDim2.new(0, 60, 0, 220)
end

flyGui.Parent = character

local flyBarFrame = Instance.new("Frame")
flyBarFrame.BackgroundTransparency = 1
flyBarFrame.AnchorPoint = Vector2.new(0, 0.5)

if isMobile then
    flyBarFrame.Size = UDim2.new(0, 8, 0, 88)
    flyBarFrame.Position = UDim2.new(0, 0, 0.5, -44)
else
    flyBarFrame.Size = UDim2.new(0, 24, 0, 220)
    flyBarFrame.Position = UDim2.new(0, 0, 0.5, -110)
end

flyBarFrame.Parent = flyGui

local flyBarBG = Instance.new("Frame")
flyBarBG.Size = UDim2.new(1, 0, 1, 0)
flyBarBG.BackgroundColor3 = Color3.fromRGB(30, 30, 60)
flyBarBG.BackgroundTransparency = 0.5
flyBarBG.BorderSizePixel = 0
flyBarBG.Parent = flyBarFrame

local flyBar = Instance.new("Frame")
flyBar.Size = UDim2.new(1, 0, 1, 0)
flyBar.Position = UDim2.new(0, 0, 1, 0)
flyBar.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
flyBar.BackgroundTransparency = 0.1
flyBar.BorderSizePixel = 0
flyBar.Parent = flyBarFrame

local flyBarText = Instance.new("TextLabel")
flyBarText.Size = UDim2.new(1, 0, 0, 16)
flyBarText.Position = UDim2.new(0, 0, 1, 4)
flyBarText.BackgroundTransparency = 1
flyBarText.TextColor3 = Color3.fromRGB(180, 220, 255)
flyBarText.Font = Enum.Font.GothamBold
flyBarText.TextScaled = true
flyBarText.Text = ""
flyBarText.Parent = flyBarFrame

flyBarFrame.Visible = false

local function setFlyBarVisible(v)
    if v then
        flyBarFrame.Visible = true
    else
        flyBarFrame.Visible = false
    end
end

local function updateFlyBar()
    local percent = math.clamp(flyMeter / flyMax, 0, 1)
    flyBar.Size = UDim2.new(1, 0, percent, 0)
    flyBar.Position = UDim2.new(0, 0, 1 - percent, 0)
    flyBarText.Text = string.format("%.1f / %d", flyMeter, flyMax)
end

-- flight start
local function flyStart()
    if flying or flyMeter <= 0 then return end

    flying = true
    setFlyBarVisible(true)

    flySpeed = root.Velocity.Magnitude

    bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(1e5,1e5,1e5)
    bv.Velocity = root.Velocity
    bv.Parent = root

    bg = Instance.new("BodyGyro")
    bg.MaxTorque = Vector3.new(1e5,1e5,1e5)
    bg.P = 1e4
    bg.D = 500
    bg.CFrame = root.CFrame
    bg.Parent = root

    flyConn = RunService.RenderStepped:Connect(function(dt)
        if not flying then
            if flyConn then flyConn:Disconnect() flyConn = nil end
            if bv then bv:Destroy() bv = nil end
            if bg then bg:Destroy() bg = nil end
            setFlyBarVisible(false)
            return
        end

        local cam = workspace.CurrentCamera
        local move = Vector3.new()

        if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end

        if move.Magnitude > 0 then move = move.Unit end

        if move.Magnitude > 0 then
            flySpeed = math.min(flySpeed + flyAccel * dt, flySpeedMax)
            bv.Velocity = move * flySpeed
            bg.CFrame = CFrame.lookAt(Vector3.new(), cam.CFrame.LookVector)
        else
            flySpeed = math.max(flySpeed - flyDecel * dt, 0)
            bv.Velocity = bv.Velocity:Lerp(Vector3.new(), math.clamp(flyInertiaDecel * dt, 0, 1))
        end

        local drain = (flySpeed >= flyDrainMinSpeed) and (flyDrainSpeed * dt) or (flyDrainIdle * dt)
        flyMeter = math.max(flyMeter - drain, 0)
        updateFlyBar()

        if flyMeter <= 0 then
            flying = false
            flyRegenCooldown = true
            task.delay(flyRegenCooldownTime, function()
                flyRegenCooldown = false
            end)
        end
    end)
end

-- flight cancel
local function flyCancel()
    if flying then
        flying = false
        setFlyBarVisible(false)
        if flyConn then flyConn:Disconnect() flyConn = nil end
        if bv then bv:Destroy() bv = nil end
        if bg then bg:Destroy() bg = nil end
        root.AssemblyLinearVelocity = Vector3.new()
    end
end

-- stamina regen
task.spawn(function()
    while true do
        if not flying and flyMeter < flyMax and not flyRegenCooldown then
            flyMeter = math.min(flyMeter + flyDrainIdle * 6, flyMax)
            updateFlyBar()
        end
        task.wait(0.5)
    end
end)

-- jump detection
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Space then
        jumpInputActive = true
        jumpInputStart = tick()
    end
end)

UserInputService.InputEnded:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Space then
        jumpInputActive = false
        if flying then flyCancel() end
    end
end)

-- jump-hold â†’ fly
task.spawn(function()
    while true do
        if jumpInputActive and not flying and flyMeter > 0 then
            if tick() - jumpInputStart >= jumpHoldThreshold then
                flyStart()
            end
        end
        if not jumpInputActive and flying then
            flyCancel()
        end
        task.wait(0.05)
    end
end)

updateFlyBar()
